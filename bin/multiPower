#!/bin/env python

from moby import *
import fftTools

paramsPath = os.environ["FLIPPER_DIR"]
binFile = paramsPath + os.path.sep + "params" + os.path.sep + 'BIN_200_LOG'
theoryFile = os.environ["WMAP_DIR"] + os.path.sep + 'wmap_3year_toKevin_lensed_v3_lensedCls.dat'

paramFile = sys.argv[1]
params = actDict.ACTDict()
params.read_from_file(paramFile)
if not "outdir" in params.keys():
    raise RuntimeError, "outdir must be specified in parameter file"

if not os.path.exists(params["outdir"]):
    os.makedirs(params["outdir"])


mapPairs = params.pop("mapPairs")
powerExec = params.pop("powerExec")
title = params.pop("title")
options = ""
for option in params.keys():
    options += " --%s '%s'" % ( option, str(params[option]))

for pair in mapPairs:
    cmd = "%s %s %s %s" % (powerExec, options, pair[0], pair[1])
    print cmd
    os.system(cmd)

files = os.listdir(params['outdir'])

bandPowers = []
for f in files:
    if not "txt" in f:
        continue
    bandPowers.append( numpy.loadtxt( "%s/%s" % (params['outdir'], f), unpack=True ) ) 
print numpy.shape(bandPowers)
bandPowers = numpy.array(bandPowers)
s = numpy.zeros(len(bandPowers[0,:,0]))
w = numpy.zeros(len(bandPowers[0,:,0]))
for bp in bandPowers:
    print bp.shape
    bp = numpy.array(bp, dtype = numpy.float64)
    s += bp[:,1]/bp[:,2]**2
    w += 1/bp[:,2]**2

s /= w
err = 1/w**.5
el = bandPowers[0,:,0]

numpy.savetxt(params['outdir'] + '/PSCrossTotal.txt', [el, s, err], fmt = "%12.6G")

fftTools.plotBinnedPower(el,s,\
                title =  title, \
                theoryFile = theoryFile,\
                yFactor = params['factor'],\
                yrange=params['yrange'],\
                maxL = params['elrange'][1],\
                ylog=False, returnPlot= True,\
                beamFWHM=params['beam'],\
                errorBars=err,\
                fitNoise=None,\
                noiseLabel=None,\
                color='red')

pylab.legend()
pylab.savefig(params['outdir']+'/PSCrossTotalLinear.png')
